<h1>Gestionnaire de tâches</h1>

<form action="index" method="GET" style="float: right">
    <submit id="btnRefresh" label="Actualiser..." />
</form>
<if test="$running">
    <form action="stop" method="GET" style="float: right">
        <submit id="btnStop" label="Arrêter..." />
    </form>
    <form action="restart" method="GET" style="float: right">
        <submit id="btnRestart" label="Redémarrer..." />
    </form>
</if>
<else>
    <form action="start" method="GET" style="float: right">
        <submit id="btnStart" label="Démarrer..." />
    </form>
</else>

<p>Statut du gestionnaire de tâches : <strong>$status</strong></p>
<p>Date/heure courante : $now</p>

<if test="$running">
    <if test="{count($tasks)}">
        <h2>Liste des tâches</h2>
        <table class="taskmanager">
            <tr>
                <th>ID</th>        
                <th>statut</th>        
                <th>site</th>        
                <th>titre</th>
                <th>tâche</th>        
                <th>planification</th>        
                <th>prochaine exécution</th>        
                <th>dernière exécution</th>        
            </tr>
            <loop on="$tasks" as="$task">
                <tr class="{$task['class']}">
                    <td>{$task['id']}</td>
                    <td>{$task['status']}</td>        
                    <td>{$task['root']}</td>        
                    <td>{$task['title']}</td>
                    <td>{$task['task']}</td>        
                    <td>
                        {$task['time']==0 ? 'dès que possible' : date('d/m/y H:i:s', $task['time'])}
                        /
                        {$task['repeat']}
                    </td>        
                    <td>
                        <if test="{isset($task['nexttime'])}">
                            {date('d/m/y H:i:s', $task['nexttime'])}
                        </if>
                        <else>
                            jamais
                        </else>
                    </td>        
                    <td>
                        <if test="{isset($task['lasttime'])}">
                            <a  href="taskstatus?id={$task['id']}" 
                                title="Voir le résultat de la dernière exécution">
                                {date('d/m/y H:i:s', $task['lasttime'])}
                            </a>
                        </if>
                        <else>
                            jamais
                        </else>
                    </td>        
                </tr>
            </loop>
        </table>
    </if>
    <else>
        <h2>Il n'y a aucune tâche en attente.</h2>
    </else>
</if>

<p>Todo :</p>
<ul>
    <li>Ne lister que les tâches appartenant au site qui consulte, sauf
    si on a des droits étendus permettant de lister tout. La commande 'list'
    devient 'list root' : on ne liste que les tâches qui ont root=à la racine
    demandée.</li>
    <li>Permettre de créer une nouvelle tâche, de supprimer une tâche 
    programmée, de changer la date d'exécution ou le champ répétition pour
    une tâche existante</li>
    <li>Pour les tâches qui ont été exécutées, permettre de voir le résultat
    de l'exécution. Ca peut être un simple log, mais aussi une page html 
    générée qu'il faut afficher. Combien d'historiques d'exécution 
    conserve-t-on ? Quand et comment les logs sont-ils purgés ?</li>
</ul>